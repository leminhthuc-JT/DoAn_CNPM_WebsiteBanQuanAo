@model IEnumerable<Admin.SanPham>

@{
    ViewBag.Title = "Cửa hàng";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<style>
    /* --- CSS CHO SIDEBAR DROPDOWN (Dùng chung cho Danh mục, Thương hiệu, Loại) --- */
    .filter-section {
        margin-bottom: 15px; /* Khoảng cách giữa các nút */
    }

    .sidebar-dropdown {
        position: relative; /* Để phần content xổ xuống neo theo nút này */
        width: 100%;
    }

    /* Nút bấm chính (Màu đen) */
    .dropdown-btn {
        background-color: #000;
        color: white;
        padding: 12px 15px;
        font-size: 14px;
        border: none;
        cursor: pointer;
        width: 100%;
        text-align: left;
        display: flex;
        justify-content: space-between;
        align-items: center;
        text-transform: uppercase;
        font-weight: bold;
        border-radius: 4px; /* Bo góc nhẹ */
    }

        .dropdown-btn:hover {
            background-color: #333;
        }

    /* Phần danh sách ẩn bên trong */
    .dropdown-content {
        display: none; /* Mặc định ẩn */
        position: absolute; /* Trôi nổi đè lên trên */
        top: 100%; /* Nằm ngay dưới nút */
        left: 0;
        background-color: #fff;
        min-width: 100%;
        box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2); /* Đổ bóng */
        z-index: 100; /* Đảm bảo nằm trên các thành phần khác */
        border: 1px solid #ddd;
    }

        /* Link bên trong danh sách */
        .dropdown-content a {
            color: #333;
            padding: 10px 15px;
            text-decoration: none;
            display: block;
            border-bottom: 1px solid #eee;
            font-size: 14px;
        }

            .dropdown-content a:hover {
                background-color: #f1f1f1;
                color: #d0021b; /* Màu đỏ khi hover */
                padding-left: 20px; /* Hiệu ứng dịch chuyển chữ */
                transition: all 0.2s;
            }

    /* --- QUAN TRỌNG: Di chuột vào khối cha thì hiện nội dung con --- */
    .sidebar-dropdown:hover .dropdown-content {
        display: block;
    }

    /* Highlight mục đang chọn trong dropdown */
    .dropdown-content a.active {
        background-color: #eee;
        color: #d0021b;
        font-weight: bold;
    }

    /* --- CSS CHO PHẦN GIÁ VÀ SIZE (Giữ nguyên dạng hiển thị) --- */
    .filter-title {
        font-weight: bold;
        text-transform: uppercase;
        font-size: 14px;
        margin-bottom: 10px;
        display: block;
        border-bottom: 2px solid #000;
        padding-bottom: 5px;
    }

    .size-tag {
        display: inline-block;
        border: 1px solid #ccc;
        padding: 5px 12px;
        margin: 3px;
        color: #333;
        text-decoration: none;
        font-size: 13px;
        border-radius: 20px;
    }

        .size-tag:hover, .size-tag.active {
            background-color: #000;
            color: white;
            border-color: #000;
        }

    .price-link {
        display: block;
        color: #555;
        padding: 5px 0;
        text-decoration: none;
    }

        .price-link.active, .price-link:hover {
            color: #d0021b;
            font-weight: bold;
        }

    /* Product Card */
    .product-card {
        transition: transform 0.3s;
        height: 100%;
    }

        .product-card:hover {
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transform: translateY(-5px);
        }

    .product-img {
        height: 200px;
        object-fit: contain;
        width: 100%;
    }
    /* CUSTOM PAGINATION */
    .pagination-container .pagination {
        margin-bottom: 0;
        gap: 5px; /* Khoảng cách giữa các nút */
    }

    .pagination-container .page-link {
        color: #333;
        border: 1px solid #e0e0e0;
        padding: 8px 16px;
        border-radius: 4px; /* Bo góc nhẹ */
        transition: all 0.3s ease;
        font-weight: 500;
        background-color: #fff;
    }

        /* Hiệu ứng khi di chuột vào */
        .pagination-container .page-link:hover {
            background-color: #f8f9fa;
            color: #000;
            border-color: #333;
            transform: translateY(-1px);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

    /* Nút trang hiện tại (Active) */
    .pagination-container .page-item.active .page-link {
        background-color: #000;
        border-color: #000;
        color: #fff;
        pointer-events: none; /* Không cho click lại trang đang xem */
    }

    /* Nút bị vô hiệu hóa (Disabled - ví dụ đang ở trang 1 thì nút Prev mờ đi) */
    .pagination-container .page-item.disabled .page-link {
        color: #ccc;
        background-color: #f9f9f9;
        border-color: #eee;
        cursor: not-allowed;
    }
</style>

<div class="container mt-5 pt-5">

    <div style="border-top: 1px solid #000; margin-bottom: 20px; padding-top: 10px; ">
        <h3 class="fw-bold">DANH SÁCH SẢN PHẨM</h3>
    </div>
    <hr />

    <div class="row">
        <!-- SIDEBAR LỌC -->
        <div class="col-md-3">

            <!-- 1. DANH MỤC (Dropdown) -->
            <div class="filter-section">
                <div class="sidebar-dropdown">
                    <button class="dropdown-btn">
                        DANH MỤC <span>&#9662;</span>
                    </button>
                    <div class="dropdown-content">
                        <a href="@Url.Action("Index", new { searchString = ViewBag.SearchString })">Tất cả</a>
                        @if (ViewBag.ListDanhMuc != null)
                        {
                            foreach (var dm in ViewBag.ListDanhMuc)
                            {
                                <a href="@Url.Action("Index", new { categoryID = dm.madm, searchString = ViewBag.SearchString })"
                                   class="@(ViewBag.CurrentCategory == dm.madm ? "active" : "")">
                                    @dm.tendm
                                </a>
                            }
                        }
                    </div>
                </div>
            </div>

            <!-- 2. THƯƠNG HIỆU (Dropdown - Mới cập nhật) -->
            <div class="filter-section">
                <div class="sidebar-dropdown">
                    <button class="dropdown-btn">
                        THƯƠNG HIỆU <span>&#9662;</span>
                    </button>
                    <div class="dropdown-content">
                        <a href="@Url.Action("Index", new { brandID = (int?)null, categoryID = ViewBag.CurrentCategory, priceRange = ViewBag.CurrentPrice })">Tất cả</a>
                        @if (ViewBag.ListThuongHieu != null)
                        {
                            foreach (var th in ViewBag.ListThuongHieu)
                            {
                                <a href="@Url.Action("Index", new { brandID = th.math, categoryID = ViewBag.CurrentCategory, priceRange = ViewBag.CurrentPrice })"
                                   class="@(ViewBag.CurrentBrand == th.math ? "active" : "")">
                                    @th.tenth
                                </a>
                            }
                        }
                    </div>
                </div>
            </div>

            <!-- 3. LOẠI SẢN PHẨM (Dropdown - Mới cập nhật) -->
            <div class="filter-section">
                <div class="sidebar-dropdown">
                    <button class="dropdown-btn">
                        LOẠI SẢN PHẨM <span>&#9662;</span>
                    </button>
                    <div class="dropdown-content">
                        <a href="@Url.Action("Index", new { typeID = (int?)null, categoryID = ViewBag.CurrentCategory, priceRange = ViewBag.CurrentPrice })">Tất cả</a>
                        @if (ViewBag.ListLoai != null)
                        {
                            foreach (var l in ViewBag.ListLoai)
                            {
                                <a href="@Url.Action("Index", new { typeID = l.maloai, categoryID = ViewBag.CurrentCategory, priceRange = ViewBag.CurrentPrice })"
                                   class="@(ViewBag.CurrentType == l.maloai ? "active" : "")">
                                    @l.tenloai
                                </a>
                            }
                        }
                    </div>
                </div>
            </div>

            <!-- 4. KÍCH CỠ (Giữ nguyên dạng tag để dễ chọn) -->
            <div class="filter-section mt-4">
                <span class="filter-title">KÍCH CỠ</span>
                <div>
                    <a href="@Url.Action("Index", new { sizeID = (int?)null, categoryID = ViewBag.CurrentCategory, brandID = ViewBag.CurrentBrand, priceRange = ViewBag.CurrentPrice })"
                       class="size-tag @(ViewBag.CurrentSize == null ? "active" : "")">All</a>

                    @if (ViewBag.ListSize != null)
                    {
                        foreach (var sz in ViewBag.ListSize)
                        {
                            <a href="@Url.Action("Index", new { sizeID = sz.mas, categoryID = ViewBag.CurrentCategory, brandID = ViewBag.CurrentBrand, priceRange = ViewBag.CurrentPrice })"
                               class="size-tag @(ViewBag.CurrentSize == sz.mas ? "active" : "")">
                                @sz.tens
                            </a>
                        }
                    }
                </div>
            </div>

            <!-- 5. MỨC GIÁ (Giữ nguyên dạng list để dễ nhìn) -->
            <div class="filter-section mt-4">
                <span class="filter-title">KHOẢNG GIÁ</span>
                <a href="@Url.Action("Index", new { priceRange = "", categoryID = ViewBag.CurrentCategory, brandID = ViewBag.CurrentBrand, typeID = ViewBag.CurrentType, sizeID = ViewBag.CurrentSize })" class="price-link @(string.IsNullOrEmpty(ViewBag.CurrentPrice) ? "active" : "")">Tất cả</a>
                <a href="@Url.Action("Index", new { priceRange = "under100", categoryID = ViewBag.CurrentCategory, brandID = ViewBag.CurrentBrand, typeID = ViewBag.CurrentType, sizeID = ViewBag.CurrentSize })" class="price-link @(ViewBag.CurrentPrice == "under100" ? "active" : "")">Dưới 100k</a>
                <a href="@Url.Action("Index", new { priceRange = "100-300", categoryID = ViewBag.CurrentCategory, brandID = ViewBag.CurrentBrand, typeID = ViewBag.CurrentType, sizeID = ViewBag.CurrentSize })" class="price-link @(ViewBag.CurrentPrice == "100-300" ? "active" : "")">100k - 300k</a>
                <a href="@Url.Action("Index", new { priceRange = "300-500", categoryID = ViewBag.CurrentCategory, brandID = ViewBag.CurrentBrand, typeID = ViewBag.CurrentType, sizeID = ViewBag.CurrentSize })" class="price-link @(ViewBag.CurrentPrice == "300-500" ? "active" : "")">300k - 500k</a>
                <a href="@Url.Action("Index", new { priceRange = "above500", categoryID = ViewBag.CurrentCategory, brandID = ViewBag.CurrentBrand, typeID = ViewBag.CurrentType, sizeID = ViewBag.CurrentSize })" class="price-link @(ViewBag.CurrentPrice == "above500" ? "active" : "")">Trên 500k</a>
            </div>

        </div>

        <!-- CONTENT SẢN PHẨM (GIỮ NGUYÊN) -->
        <div class="col-md-9">
            <!-- Search & Sort Bar -->
            <div class="row mb-3">
                <div class="col-md-8">
                    <form action="@Url.Action("Index", "Product")" method="get">
                        <div class="input-group">
                            <input type="text" class="form-control" placeholder="Tìm tên sản phẩm..." name="searchString" value="@ViewBag.SearchString">
                            <button class="btn btn-dark" type="submit"><i class="fa fa-search"></i> Tìm</button>
                        </div>
                    </form>
                </div>
                <div class="col-md-4 text-end">
                    <select class="form-select" onchange="location = this.value;">
                        <option value="@Url.Action("Index", new { sortOrder = "default", categoryID = ViewBag.CurrentCategory })" @(ViewBag.CurrentSort == null ? "selected" : "")>Sắp xếp mặc định</option>
                        <option value="@Url.Action("Index", new { sortOrder = "price_asc", categoryID = ViewBag.CurrentCategory })" @(ViewBag.CurrentSort == "price_asc" ? "selected" : "")>Giá thấp đến cao</option>
                        <option value="@Url.Action("Index", new { sortOrder = "price_desc", categoryID = ViewBag.CurrentCategory })" @(ViewBag.CurrentSort == "price_desc" ? "selected" : "")>Giá cao đến thấp</option>
                        <option value="@Url.Action("Index", new { sortOrder = "sales", categoryID = ViewBag.CurrentCategory })" @(ViewBag.CurrentSort == "sales" ? "selected" : "")>Lượt bán</option>
                        <option value="@Url.Action("Index", new { sortOrder = "newest", categoryID = ViewBag.CurrentCategory })" @(ViewBag.CurrentSort == "newest" ? "selected" : "")>Mới nhất</option>
                    </select>
                </div>
            </div>

            <div class="row">
                @if (Model != null && Model.Any())
                {
                    foreach (var item in Model)
                    {
                        <div class="col-md-4 col-sm-6 mb-4">
                            <div class="card product-card border-0">
                                <a href="@Url.Action("ChiTietSP", "Product", new { masp = item.masp })">
                                    <img src="~/Content/ImageSP/@item.anhchinh" class="product-img card-img-top" alt="@item.tensp" />
                                </a>
                                <div class="card-body text-center">
                                    <h6 class="card-title text-truncate">
                                        <a href="@Url.Action("ChiTietSP", "Product", new { masp = item.masp })" class="text-decoration-none text-dark">@item.tensp</a>
                                    </h6>
                                    <p class="text-danger fw-bold">@string.Format("{0:N0} đ", item.giaban)</p>
                                </div>
                            </div>
                        </div>
                    }
                }
                else
                {
                    <div class="col-12 text-center py-5">
                        <h4 class="text-muted">Không tìm thấy sản phẩm.</h4>
                    </div>
                }
            </div>

            <!-- Phân trang -->
            <div class="row mt-5">
                <div class="col-12 d-flex justify-content-center pagination-container">
                    @if (ViewBag.TotalPages > 1)
                    {
                        <nav aria-label="Page navigation">
                            <ul class="pagination">
                                @{
                                    // Hàm tạo URL helper
                                    Func<int, string> generateUrl = (pageNum) => Url.Action("Index", new
                                    {
                                        page = pageNum,
                                        sortOrder = ViewBag.CurrentSort,
                                        categoryID = ViewBag.CurrentCategory,
                                        brandID = ViewBag.CurrentBrand,
                                        typeID = ViewBag.CurrentType,
                                        sizeID = ViewBag.CurrentSize,
                                        priceRange = ViewBag.CurrentPrice,
                                        searchString = ViewBag.SearchString
                                    });
                                }

                                <!-- Nút Previous (Về trước) -->
                                <li class="page-item @(ViewBag.CurrentPage == 1 ? "disabled" : "")">
                                    <a class="page-link" href="@(ViewBag.CurrentPage > 1 ? generateUrl(ViewBag.CurrentPage - 1) : "#")" aria-label="Previous">
                                        <span aria-hidden="true">&laquo;</span>
                                    </a>
                                </li>

                                <!-- Các nút số trang -->
                                @for (int i = 1; i <= ViewBag.TotalPages; i++)
                                {
                                    <li class="page-item @(i == ViewBag.CurrentPage ? "active" : "")">
                                        <a class="page-link" href="@generateUrl(i)">@i</a>
                                    </li>
                                }

                                <!-- Nút Next (Tiếp theo) -->
                                <li class="page-item @(ViewBag.CurrentPage == ViewBag.TotalPages ? "disabled" : "")">
                                    <a class="page-link" href="@(ViewBag.CurrentPage < ViewBag.TotalPages ? generateUrl(ViewBag.CurrentPage + 1) : "#")" aria-label="Next">
                                        <span aria-hidden="true">&raquo;</span>
                                    </a>
                                </li>
                            </ul>
                        </nav>
                    }
                </div>
            </div>
        </div>
    </div>
</div>
